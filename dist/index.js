/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";class t extends Error{constructor(t){super(t),this.retryable=!0}}class e extends Error{constructor(t){super(t),this.retryable=!1}}var o={invoke:async(o,r)=>{console.log("Starting HashiCorp Boundary Remove User from Group action");try{!function(t){if(!t.groupId||"string"!=typeof t.groupId||""===t.groupId.trim())throw new e("Invalid or missing groupId parameter");if(!t.userId||"string"!=typeof t.userId||""===t.userId.trim())throw new e("Invalid or missing userId parameter");if(!t.authMethodId||"string"!=typeof t.authMethodId||""===t.authMethodId.trim())throw new e("Invalid or missing authMethodId parameter")}(o);const{groupId:n,userId:s,authMethodId:a}=o;if(console.log(`Processing group ID: ${n}, user ID: ${s}`),!r.secrets?.BASIC_USERNAME||!r.secrets?.BASIC_PASSWORD)throw new e("Missing required secrets: BASIC_USERNAME and BASIC_PASSWORD");const i=function(t,e){const o=e.environment||{},r=t?.address||o.ADDRESS;if(!r)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return r.endsWith("/")?r.slice(0,-1):r}(o,r);console.log(`Authenticating with auth method: ${a}`);const u=await async function(o,r,n,s){const a=`${s}/v1/auth-methods/${encodeURIComponent(o)}:authenticate`,i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attributes:{login_name:r,password:n}})});if(!i.ok){const o=await i.text();if(429===i.status)throw new t("Boundary API rate limit exceeded");if(401===i.status||403===i.status)throw new e("Invalid username or password");if(i.status>=500)throw new t(`Boundary API server error: ${i.status}`);throw new e(`Failed to authenticate: ${i.status} ${i.statusText} - ${o}`)}const u=await i.json();if(!u.attributes?.token)throw new e("No token returned from authentication");return u.attributes.token}(a,r.secrets.BASIC_USERNAME,r.secrets.BASIC_PASSWORD,i);await new Promise(t=>setTimeout(t,100)),console.log(`Getting group details for: ${n}`);const d=await async function(o,r,n){const s=`${n}/v1/groups/${encodeURIComponent(o)}`,a=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(!a.ok){const r=await a.text();if(429===a.status)throw new t("Boundary API rate limit exceeded");if(401===a.status)throw new e("Invalid or expired authentication token");if(404===a.status)throw new e(`Group not found: ${o}`);if(a.status>=500)throw new t(`Boundary API server error: ${a.status}`);throw new e(`Failed to get group: ${a.status} ${a.statusText} - ${r}`)}const i=await a.json();if(!i.version)throw new e("No version returned from group");return i.version}(n,u,i);await new Promise(t=>setTimeout(t,100)),console.log(`Removing user ${s} from group ${n} with version: ${d}`),await async function(o,r,n,s,a){const i=`${a}/v1/groups/${encodeURIComponent(o)}:remove-members`,u=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({version:n,member_ids:[r]})});if(!u.ok){const n=await u.text();if(429===u.status)throw new t("Boundary API rate limit exceeded");if(401===u.status)throw new e("Invalid or expired authentication token");if(404===u.status)throw new e(`Group or user not found: ${o} / ${r}`);if(409===u.status)throw new e(`Conflict (user may not be in group): ${n}`);if(u.status>=500)throw new t(`Boundary API server error: ${u.status}`);throw new e(`Failed to remove user from group: ${u.status} ${u.statusText} - ${n}`)}return!0}(n,s,d,u,i);const c={groupId:n,userId:s,authMethodId:a,userRemoved:!0,removedAt:(new Date).toISOString()};return console.log(`Successfully removed user ${s} from group ${n}`),c}catch(o){if(console.error(`Error removing user from Boundary group: ${o.message}`),o instanceof t||o instanceof e)throw o;throw new e(`Unexpected error: ${o.message}`)}},error:async(t,e)=>{const{error:o}=t;throw console.error(`Error handler invoked: ${o?.message}`),o},halt:async(t,e)=>{const{reason:o,groupId:r,userId:n,authMethodId:s}=t;return console.log(`Job is being halted (${o})`),{groupId:r||"unknown",userId:n||"unknown",authMethodId:s||"unknown",reason:o||"unknown",haltedAt:(new Date).toISOString(),cleanupCompleted:!0}}};module.exports=o;
